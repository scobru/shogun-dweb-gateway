<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DWeb Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    #msg {
      margin-bottom: 20px;
      font-size: 1.2em;
    }

    .error {
      color: #ff3333;
    }

    .loading {
      color: #00a3ff;
    }
  </style>
</head>
<body>
  <div id="msg" class="loading">Caricamento app...</div>
  <div style="font-size: 0.8em; color: #666">
    Relay: shogun-relay.scobrudot.dev
  </div>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script>
    const RELAY_URL = 'https://shogun-relay.scobrudot.dev/gun';
    const msg = document.getElementById('msg');

    // Ottieni username e nome pagina dal percorso URL
    // Esempio: /view/username/pagename -> username, pagename
    // Esempio: /view/username -> username, null (default: cerca 'site')
    const pathParts = window.location.pathname.split('/').filter(p => p && p !== 'viewer.html');
    const username = pathParts[1]; // /view/username o /view/username/page
    const pageName = pathParts[2] || 'site'; // Se non specificato, usa 'site' come default per retrocompatibilità

    if (!username || username === 'view') {
      msg.innerText = '❌ Username non specificato';
      msg.className = 'error';
      setTimeout(() => {
        window.location.href = '/dweb';
      }, 2000);
      throw new Error('Username non specificato');
    }

    console.log('Cercando app per username:', username, 'page:', pageName);

    try {
      const gun = new Gun({
        peers: [RELAY_URL],
        localStorage: false,
        radisk: false
      });

      msg.innerText = `Connesso al Relay. Ricerca app "${pageName}" di "${username}"...`;

      let appFound = false;
      const timeoutId = setTimeout(() => {
        if (!appFound && document.body.style.background === 'rgb(0, 0, 0)') {
          msg.innerHTML = '<span class="error">❌ App "' + pageName + '" non trovata per username: "' + username + '"</span><br>' +
                         '<span style="color: #666; font-size: 0.9em;">Verifica che l\'username e il nome della pagina siano corretti e che l\'app sia stata pubblicata.</span>';
        }
      }, 10000);

      const renderApp = (html) => {
        appFound = true;
        clearTimeout(timeoutId);
        msg.innerText = '✅ App trovata! Rendering...';
        
        setTimeout(() => {
          document.open();
          document.write(html);
          document.close();
        }, 500);
      };

      // Cerca prima il mapping globale username -> pub
      const mappingNode = gun.get('dweb').get('users').get(username);
      
      console.log('Cercando mapping per username:', username);
      
      // Prova con .once() prima, poi fallback a .on() se non trova
      mappingNode.once((mapping) => {
        console.log('Risposta mapping .once():', mapping);
        
        if (mapping && mapping.pub) {
          // Trovato mapping, cerca l'app usando la pub key
          console.log('✓ Mapping trovato, pub key:', mapping.pub);
          // Cerca la pagina specifica: ~pub/sites/pagename
          const appNode = gun.get('~' + mapping.pub).get('sites').get(pageName);
          
          appNode.on((data) => {
            console.log('Dati app ricevuti:', data);
            if (data && data.html) {
              renderApp(data.html);
            }
          });
        } else {
          // Prova anche con .on() per mapping (in caso non fosse ancora propagato)
          console.log('Mapping non trovato con .once(), provo con .on()...');
          let mappingFound = false;
          
          mappingNode.on((mapping) => {
            if (!mappingFound && mapping && mapping.pub) {
              mappingFound = true;
              console.log('✓ Mapping trovato con .on(), pub key:', mapping.pub);
              const appNode = gun.get('~' + mapping.pub).get('sites').get(pageName);
              
              appNode.on((data) => {
                console.log('Dati app ricevuti:', data);
                if (data && data.html) {
                  renderApp(data.html);
                }
              });
            }
          });
          
          // Fallback: prova a cercare direttamente l'utente per alias
          setTimeout(() => {
            if (!mappingFound && !appFound) {
              console.log('Mapping ancora non trovato, provo ricerca diretta per alias...');
              // Prova prima con la nuova struttura sites/pagename
              gun.user(username).get('sites').get(pageName).on((data) => {
                console.log('Dati ricevuti (fallback alias, nuova struttura):', data);
                if (data && data.html) {
                  renderApp(data.html);
                }
              });
              
              // Fallback aggiuntivo per retrocompatibilità (vecchia struttura site)
              if (pageName === 'site') {
                gun.user(username).get('site').on((data) => {
                  console.log('Dati ricevuti (fallback alias, vecchia struttura):', data);
                  if (data && data.html) {
                    renderApp(data.html);
                  } else {
                    console.log('In attesa di dati o sincronizzazione in corso...');
                  }
                });
              }
            }
          }, 2000);
        }
      });

    } catch (e) {
      msg.innerText = 'Errore critico: ' + e.message;
      msg.className = 'error';
    }
  </script>
</body>
</html>
