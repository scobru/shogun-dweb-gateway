<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unstoppable Lido Loader</title>
    <style>
      body {
        background: #000;
        color: #0f0;
        font-family: monospace;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        padding: 20px;
        text-align: center;
      }

      #msg {
        margin-bottom: 20px;
        font-size: 1.2em;
      }

      .error {
        color: #ff3333;
      }

      .loading {
        color: #00a3ff;
      }
    </style>
  </head>

  <body>
    <div id="msg" class="loading">Inizializzazione nodo GunDB...</div>
    <div style="font-size: 0.8em; color: #666">
      Relay: shogun-relay.scobrudot.dev
    </div>

    <!-- Librerie Gun + SEA -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <script async>
      (async () => {
      // --- CONFIGURAZIONE ---
      // INCOLLA QUI LA 'PUB KEY' CHE TI HA DATO LO SCRIPT NODE.JS
      // Esempio formato: "stringa_lunga.altra_stringa_lunga"
      const AUTHOR_PUB_KEY =
        "hMDrYQQP__DFMKwAB4vmXpGNPXekpPaf471QQMRK7wI.0lu3YoQ0fF60IvqlCYHrLACgkFpy8eqAKv4wmN61-mQ"

      const APP_NAME = "test-site";
      const RELAY_URL = "https://shogun-relay.scobrudot.dev/gun";
      // ----------------------

      const msg = document.getElementById("msg");

      try {
        // Usa l'array per i peer
        const gun = new Gun({
          peers: [RELAY_URL],
          localStorage: false,
          radisk: false
        });

        console.log(gun);
        console.log(AUTHOR_PUB_KEY);
        console.log(APP_NAME);
        console.log(RELAY_URL);

        

        msg.innerText = "Connesso al Relay. Ricerca dati firmati...";
        console.log("Cercando dati per pub key:", AUTHOR_PUB_KEY);
        console.log("Path completo:", "~" + AUTHOR_PUB_KEY + "/" + APP_NAME);

        const node = gun.get("~" + AUTHOR_PUB_KEY).get(APP_NAME);

        // Prova prima con .once() per un'osservazione immediata
        node.once((data) => {
          console.log("Dati ricevuti (once):", data);
          if (data && data.html) {
            msg.innerText = "Firma crittografica valida! Rendering...";
            setTimeout(() => {
              document.open();
              document.write(data.html);
              document.close();
            }, 500);
          }
        });

        // Ascolta anche con .on() per aggiornamenti in tempo reale
        // Il simbolo '~' indica "cerca per chiave pubblica"
        let dataFound = false;
        const timeoutId = setTimeout(() => {
          if (!dataFound && document.body.style.background === "rgb(0, 0, 0)") {
            // Se siamo ancora nella pagina nera
            msg.innerHTML +=
              "<br><span class='error'>(Nessun dato trovato dopo 10s)</span>" +
              "<br><span class='error'>Verifica:</span>" +
              "<br><span class='error'>1. La PubKey in index.html corrisponde a quella usata per pubblicare</span>" +
              "<br><span class='error'>2. Il relay è raggiungibile</span>" +
              "<br><span class='error'>3. I dati sono stati pubblicati correttamente</span>" +
              "<br><span style='color: #888; font-size: 0.9em'>Apri la console del browser (F12) per vedere i dettagli</span>";
            console.error("Timeout: nessun dato trovato. PubKey:", AUTHOR_PUB_KEY);
            console.error("Path cercato:", "~" + AUTHOR_PUB_KEY + "/" + APP_NAME);
          }
        }, 10000);

        node.on((data) => {
          console.log("Dati ricevuti (on):", data);
          if (data && data.html) {
            dataFound = true;
            clearTimeout(timeoutId);
            msg.innerText = "Firma crittografica valida! Rendering...";

            // Delay estetico minimo per leggere il messaggio, poi renderizza
            setTimeout(() => {
              document.open();
              document.write(data.html);
              document.close();
            }, 500);
          } else {
            // Gun continua a cercare, questo non è necessariamente un errore
            console.log("In attesa di dati o sincronizzazione in corso...");
          }
        });
        
      } catch (e) {
        msg.innerText = "Errore critico: " + e.message;
        msg.className = "error";
      }
    })();
    </script>
    </body>
    </html>

